---
- name: Create PostgreSQL server
  azure_rm_postgresqlserver:
    resource_group: "{{ azure_resource_group }}"
    name: "pueblo-market-db"
    sku:
      name: "{{ database_sku }}"
      tier: "Burstable"
    storage_mb: 32768
    admin_username: "{{ db_user }}"
    admin_password: "{{ db_password }}"
    version: "14"
    ssl_enforcement: "Enabled"
    location: "{{ azure_location }}"
    subscription_id: "{{ azure_subscription_id }}"

- name: Configure PostgreSQL firewall
  azure_rm_postgresqlfirewallrule:
    resource_group: "{{ azure_resource_group }}"
    server_name: "pueblo-market-db"
    name: "allow-all"
    start_ip_address: "0.0.0.0"
    end_ip_address: "255.255.255.255"
    subscription_id: "{{ azure_subscription_id }}"

- name: Create database
  azure_rm_postgresqldatabase:
    resource_group: "{{ azure_resource_group }}"
    server_name: "pueblo-market-db"
    name: "{{ db_name }}"
    subscription_id: "{{ azure_subscription_id }}"

- name: Create Redis cache
  azure_rm_rediscache:
    resource_group: "{{ azure_resource_group }}"
    name: "pueblo-market-redis"
    location: "{{ azure_location }}"
    sku:
      name: "{{ redis_sku }}"
      size: "C1"
    enable_non_ssl_port: false
    redis_configuration:
      maxmemory-policy: "allkeys-lru"
    subscription_id: "{{ azure_subscription_id }}"
